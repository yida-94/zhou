<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yida è¿›é”€å­˜ Â· Gestion de stock</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #f2f7fd;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .app {
            max-width: 1500px;
            width: 100%;
            background: white;
            border-radius: 40px;
            box-shadow: 0 25px 50px -10px rgba(0,40,80,0.2);
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header h1 {
            margin: 0;
            color: #0a314a;
            font-size: 2.2rem;
        }
        .header h1 small {
            font-size: 1rem;
            background: #e2effa;
            color: #1d5980;
            padding: 5px 18px;
            border-radius: 40px;
            margin-left: 15px;
            font-weight: 400;
        }
        .badge {
            background: #0a314a;
            color: white;
            padding: 8px 25px;
            border-radius: 40px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1.1fr 2.2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 30px;
            padding: 25px;
            border: 1px solid #dae8f2;
            box-shadow: 0 5px 15px rgba(0,20,40,0.03);
        }
        .card h2 {
            margin: 0 0 20px 0;
            color: #133f60;
            font-size: 1.5rem;
            border-bottom: 2px solid #deecf7;
            padding-bottom: 12px;
        }
        .fr {
            color: #54799b;
            font-size: 0.9rem;
            font-weight: 400;
            margin-left: 8px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #1b4970;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        input, select {
            width: 100%;
            padding: 12px 18px;
            border: 1.5px solid #c9dcf0;
            border-radius: 25px;
            font-size: 0.95rem;
            background: #fafdff;
        }
        input:focus, select:focus {
            border-color: #1a73b0;
            outline: none;
            box-shadow: 0 0 0 3px rgba(20,100,180,0.15);
        }
        .btn {
            background: #0f4170;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
            transition: 0.15s;
        }
        .btn:hover {
            background: #0b3457;
        }
        .btn-sm {
            padding: 5px 12px;
            border-radius: 30px;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            margin: 0 3px;
        }
        .btn-edit {
            background: #2575a5;
            color: white;
        }
        .btn-delete {
            background: #c43a3a;
            color: white;
        }
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #eaf2fa;
            padding: 12px;
            border-radius: 60px;
            margin-bottom: 20px;
        }
        .filter-btn {
            padding: 6px 22px;
            border-radius: 40px;
            border: none;
            background: transparent;
            color: #1d4f78;
            font-weight: 500;
            cursor: pointer;
            transition: 0.1s;
        }
        .filter-btn.active {
            background: white;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }
        .table-wrap {
            border: 1px solid #d7e6f5;
            border-radius: 20px;
            overflow: auto;
            max-height: 350px;
            background: #fbfeff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 850px;
        }
        th {
            background: #e1edf9;
            color: #103f63;
            font-weight: 600;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #c0d6ec;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddeaf5;
        }
        .cat-badge {
            background: #daebfc;
            padding: 4px 14px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #0e4b79;
            display: inline-block;
        }
        .stat-panel {
            background: #edf5fe;
            border-radius: 24px;
            padding: 18px 22px;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            border: 1px solid #c9def5;
        }
        .stat-item {
            text-align: center;
            min-width: 90px;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #366187;
        }
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0f3f66;
            line-height: 1.2;
        }
        .cycle-section {
            margin-top: 40px;
        }
        .section-title {
            font-size: 1.5rem;
            color: #133f60;
            border-bottom: 2px solid #d0e2f3;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        .summary-box {
            background: #edf5fe;
            border-radius: 24px;
            padding: 18px 22px;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border: 1px solid #c9def5;
        }
        .summary-box > div {
            flex: 1;
        }
        .stable { color: #2e7d32; font-weight: 600; }
        .unstable { color: #ed6c02; font-weight: 600; }
        .very-unstable { color: #d32f2f; font-weight: 600; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
        }
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .btn-cancel {
            background: #7a8f9f;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }
    </style>
</head>
<body>
<div class="app">
    <!-- å¤´éƒ¨ Header -->
    <div class="header">
        <h1>ğŸ“¦ yida è¿›é”€å­˜ <small>Gestion de stock</small></h1>
        <div class="badge">ğŸ‡«ğŸ‡· FR / ä¸­æ–‡</div>
    </div>

    <!-- å·¦å³åŒæ  Grid -->
    <div class="grid-2">
        <!-- å·¦ä¾§ï¼šå…¥åº“ç™»è®° Enregistrement -->
        <div class="card">
            <h2>ğŸ“¥ ç™»è®°å…¥åº“ <span class="fr">Â· Nouvelle entrÃ©e</span></h2>
            <div class="form-group">
                <label>ğŸ“… æ—¶é—´ <span class="fr">(Date/Heure)</span></label>
                <input type="datetime-local" id="inTime">
            </div>
            <div class="form-group">
                <label>ğŸ¢ å…¬å¸ <span class="fr">(Fournisseur)</span></label>
                <input type="text" id="company" placeholder="Ex: yida distribution">
            </div>
            <div class="form-group">
                <label>ğŸ“¦ äº§å“ <span class="fr">(Produit)</span></label>
                <input type="text" id="product" placeholder="Ex: yidaçº¸å·¾" list="productList">
                <datalist id="productList"></datalist>
            </div>
            <div class="form-group">
                <label>ğŸ”¢ æ•°é‡ <span class="fr">(QuantitÃ©)</span></label>
                <input type="number" id="quantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label>ğŸ·ï¸ ç±»åˆ« <span class="fr">(CatÃ©gorie)</span></label>
                <select id="category">
                    <option value="yidaç‰Œ">yidaç‰Œ Â· Marque yida</option>
                    <option value="å¹²è´§">å¹²è´§ Â· Sec</option>
                    <option value="å†»è´§">å†»è´§ Â· SurgelÃ©</option>
                    <option value="é¥®æ–™">é¥®æ–™ Â· Boisson</option>
                    <option value="å«ç”Ÿç”¨å“">å«ç”Ÿç”¨å“ Â· HygiÃ¨ne</option>
                </select>
            </div>
            <button class="btn" id="addBtn">âœ… ä¿å­˜å…¥åº“ Â· Enregistrer</button>
        </div>

        <!-- å³ä¾§ï¼šå†å²è®°å½• Historique -->
        <div class="card">
            <h2>ğŸ“‹ å†å²è®°å½• <span class="fr">Â· Historique</span></h2>
            
            <!-- åˆ†ç±»æ ‡ç­¾ Filtres -->
            <div class="filter-bar" id="historyFilter">
                <button class="filter-btn active" data-filter="all">ğŸ“‹ å…¨éƒ¨ Â· Tous</button>
                <button class="filter-btn" data-filter="yidaç‰Œ">ğŸ”¹ yidaç‰Œ</button>
                <button class="filter-btn" data-filter="å¹²è´§">ğŸŒ¿ å¹²è´§</button>
                <button class="filter-btn" data-filter="å†»è´§">â„ï¸ å†»è´§</button>
                <button class="filter-btn" data-filter="é¥®æ–™">ğŸ¥¤ é¥®æ–™</button>
                <button class="filter-btn" data-filter="å«ç”Ÿç”¨å“">ğŸ§» å«ç”Ÿç”¨å“</button>
            </div>

            <!-- è¡¨æ ¼ Table -->
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´ <span class="fr">(Date)</span></th>
                            <th>å…¬å¸ <span class="fr">(Fourn.)</span></th>
                            <th>äº§å“ <span class="fr">(Produit)</span></th>
                            <th>æ•°é‡ <span class="fr">(QtÃ©)</span></th>
                            <th>ç±»åˆ« <span class="fr">(Cat.)</span></th>
                            <th>æ“ä½œ <span class="fr">(Actions)</span></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ Statistiques -->
            <div class="stat-panel">
                <select id="statsCat" style="padding:8px 15px;border-radius:30px;border:1px solid #b5d0ea;">
                    <option value="all">ğŸ“Š å…¨éƒ¨ç±»åˆ« Â· Toutes</option>
                    <option value="yidaç‰Œ">ğŸ”¹ yidaç‰Œ</option>
                    <option value="å¹²è´§">ğŸŒ¿ å¹²è´§</option>
                    <option value="å†»è´§">â„ï¸ å†»è´§</option>
                    <option value="é¥®æ–™">ğŸ¥¤ é¥®æ–™</option>
                    <option value="å«ç”Ÿç”¨å“">ğŸ§» å«ç”Ÿç”¨å“</option>
                </select>
                <div class="stat-item"><span class="stat-label">1ä¸ªæœˆ <span class="fr">(1 mois)</span></span><div class="stat-number" id="stat1m">0</div></div>
                <div class="stat-item"><span class="stat-label">3ä¸ªæœˆ <span class="fr">(3 mois)</span></span><div class="stat-number" id="stat3m">0</div></div>
                <div class="stat-item"><span class="stat-label">6ä¸ªæœˆ <span class="fr">(6 mois)</span></span><div class="stat-number" id="stat6m">0</div></div>
                <div class="stat-item"><span class="stat-label">1å¹´ <span class="fr">(1 an)</span></span><div class="stat-number" id="stat1y">0</div></div>
                <button class="btn-sm" style="background:#b33;color:white;" id="clearAllBtn">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨ Â· Tout effacer</button>
            </div>
        </div>
    </div>

    <!-- è®¢è´§å‘¨æœŸåˆ†æ Analyse du cycle -->
    <div class="cycle-section">
        <div class="section-title">ğŸ”„ è®¢è´§å‘¨æœŸåˆ†æ <span class="fr">Â· Analyse du cycle de commande</span></div>
        
        <!-- å‘¨æœŸåˆ†ç±»æ ‡ç­¾ Filtres cycle -->
        <div class="filter-bar" id="cycleFilter">
            <button class="filter-btn active" data-cycle="all">ğŸ“‹ å…¨éƒ¨ Â· Tous</button>
            <button class="filter-btn" data-cycle="yidaç‰Œ">ğŸ”¹ yidaç‰Œ</button>
            <button class="filter-btn" data-cycle="å¹²è´§">ğŸŒ¿ å¹²è´§</button>
            <button class="filter-btn" data-cycle="å†»è´§">â„ï¸ å†»è´§</button>
            <button class="filter-btn" data-cycle="é¥®æ–™">ğŸ¥¤ é¥®æ–™</button>
            <button class="filter-btn" data-cycle="å«ç”Ÿç”¨å“">ğŸ§» å«ç”Ÿç”¨å“</button>
        </div>

        <!-- æ±‡æ€»å¡ç‰‡ RÃ©sumÃ© -->
        <div class="summary-box">
            <div><span class="stat-label">ğŸ“Š äº§å“æ€»æ•° <span class="fr">(Total produits)</span></span><div class="stat-number" id="totalProducts">0</div></div>
            <div><span class="stat-label">ğŸ“¦ å…¥åº“æ¬¡æ•° <span class="fr">(Total entrÃ©es)</span></span><div class="stat-number" id="totalEntries">0</div></div>
            <div><span class="stat-label">â±ï¸ å¹³å‡å‘¨æœŸ <span class="fr">(Cycle moyen)</span></span><div class="stat-number" id="avgCycle">-</div></div>
        </div>

        <!-- å‘¨æœŸè¡¨æ ¼ Tableau des cycles -->
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>äº§å“ <span class="fr">(Produit)</span></th>
                        <th>ç±»åˆ« <span class="fr">(Cat.)</span></th>
                        <th>æ¬¡æ•° <span class="fr">(Nb)</span></th>
                        <th>é¦–æ¬¡ <span class="fr">(Premier)</span></th>
                        <th>æœ€è¿‘ <span class="fr">(Dernier)</span></th>
                        <th>å¹³å‡å‘¨æœŸ <span class="fr">(Cycle moy.)</span></th>
                        <th>æœ€çŸ­/æœ€é•¿ <span class="fr">(Min/Max)</span></th>
                        <th>ç¨³å®šæ€§ <span class="fr">(Stab.)</span></th>
                        <th>å»ºè®®ä¸‹æ¬¡ <span class="fr">(Prochain)</span></th>
                    </tr>
                </thead>
                <tbody id="cycleBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å¼¹çª— Modal d'Ã©dition -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">âœï¸ ç¼–è¾‘è®°å½• <span class="fr">Â· Modifier</span></h3>
        <div class="form-group">
            <label>ğŸ“… æ—¶é—´ <span class="fr">(Date/Heure)</span></label>
            <input type="datetime-local" id="editInTime">
        </div>
        <div class="form-group">
            <label>ğŸ¢ å…¬å¸ <span class="fr">(Fournisseur)</span></label>
            <input type="text" id="editCompany">
        </div>
        <div class="form-group">
            <label>ğŸ“¦ äº§å“ <span class="fr">(Produit)</span></label>
            <input type="text" id="editProduct">
        </div>
        <div class="form-group">
            <label>ğŸ”¢ æ•°é‡ <span class="fr">(QuantitÃ©)</span></label>
            <input type="number" id="editQuantity" min="1">
        </div>
        <div class="form-group">
            <label>ğŸ·ï¸ ç±»åˆ« <span class="fr">(CatÃ©gorie)</span></label>
            <select id="editCategory">
                <option value="yidaç‰Œ">yidaç‰Œ Â· Marque yida</option>
                <option value="å¹²è´§">å¹²è´§ Â· Sec</option>
                <option value="å†»è´§">å†»è´§ Â· SurgelÃ©</option>
                <option value="é¥®æ–™">é¥®æ–™ Â· Boisson</option>
                <option value="å«ç”Ÿç”¨å“">å«ç”Ÿç”¨å“ Â· HygiÃ¨ne</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn" id="saveEditBtn" style="flex:2;">ğŸ’¾ ä¿å­˜ Â· Sauvegarder</button>
            <button class="btn-cancel" id="cancelEditBtn">âŒ å–æ¶ˆ Â· Annuler</button>
        </div>
    </div>
</div>

<script>
(function() {
    // æ•°æ®å­˜å‚¨
    const STORAGE_KEY = 'yida_stock_fr';
    let records = [];
    let currentEditId = null;
    let historyFilter = 'all';
    let cycleFilter = 'all';

    // åŠ è½½æ•°æ®
    function loadData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try { records = JSON.parse(stored) || []; } 
            catch { records = []; }
        } else {
            records = [];
        }
    }
    loadData();

    // ä¿å­˜æ•°æ®
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    // å®‰å…¨è½¬ä¹‰
    function escape(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"]/g, function(c) {
            if (c === '&') return '&amp;';
            if (c === '<') return '&lt;';
            if (c === '>') return '&gt;';
            if (c === '"') return '&quot;';
            return c;
        });
    }

    // ========== æ¸²æŸ“å†å²è¡¨æ ¼ ==========
    function renderHistory() {
        const tbody = document.getElementById('historyBody');
        let filtered = records;
        if (historyFilter !== 'all') {
            filtered = records.filter(r => r.category === historyFilter);
        }
        const sorted = [...filtered].sort((a,b) => (b.inTime||'').localeCompare(a.inTime||''));

        if (!sorted.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;">ğŸ“­ æš‚æ— è®°å½• Â· Aucune donnÃ©e</td></tr>';
            return;
        }

        let html = '';
        sorted.forEach(r => {
            const time = (r.inTime || '').replace('T', ' ');
            html += `<tr data-id="${r.id}">
                <td>${escape(time)}</td>
                <td>${escape(r.company)}</td>
                <td>${escape(r.product)}</td>
                <td>${r.quantity || 0}</td>
                <td><span class="cat-badge">${escape(r.category)}</span></td>
                <td>
                    <button class="btn-sm btn-edit" data-id="${r.id}">âœï¸ ç¼–è¾‘</button>
                    <button class="btn-sm btn-delete" data-id="${r.id}">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // ========== æ¸²æŸ“ç»Ÿè®¡ ==========
    function renderStats() {
        const cat = document.getElementById('statsCat').value;
        const months = [1,3,6,12];
        const targets = ['stat1m', 'stat3m', 'stat6m', 'stat1y'];
        
        targets.forEach((id, idx) => {
            const m = months[idx];
            const cutoff = new Date();
            cutoff.setMonth(cutoff.getMonth() - m);
            
            let total = 0;
            records.forEach(r => {
                if (cat !== 'all' && r.category !== cat) return;
                const d = new Date(r.inTime);
                if (!isNaN(d) && d >= cutoff) {
                    total += Number(r.quantity) || 0;
                }
            });
            document.getElementById(id).innerText = total;
        });
    }

    // ========== æ¸²æŸ“å‘¨æœŸåˆ†æ ==========
    function renderCycle() {
        // è¿‡æ»¤æ•°æ®
        let data = records;
        if (cycleFilter !== 'all') {
            data = records.filter(r => r.category === cycleFilter);
        }

        // æŒ‰äº§å“åˆ†ç»„
        const groups = {};
        data.forEach(r => {
            if (!r.product) return;
            if (!groups[r.product]) groups[r.product] = [];
            groups[r.product].push(r);
        });

        const cycles = [];
        let totalCycleSum = 0, cycleCount = 0;

        Object.keys(groups).forEach(prod => {
            const list = groups[prod].sort((a,b) => new Date(a.inTime) - new Date(b.inTime));
            const first = list[0].inTime.split('T')[0];
            const last = list[list.length-1].inTime.split('T')[0];
            const category = list[0].category;

            // è®¡ç®—é—´éš”
            const intervals = [];
            for (let i=1; i<list.length; i++) {
                const days = (new Date(list[i].inTime) - new Date(list[i-1].inTime)) / (1000*3600*24);
                intervals.push(days);
            }

            let avg = '-', min = '-', max = '-', stability = '-', style = '';
            if (intervals.length > 0) {
                const sum = intervals.reduce((a,b) => a+b, 0);
                avg = (sum / intervals.length).toFixed(1);
                min = Math.min(...intervals).toFixed(1);
                max = Math.max(...intervals).toFixed(1);

                if (intervals.length > 1) {
                    const mean = sum / intervals.length;
                    const variance = intervals.reduce((a,b) => a + Math.pow(b-mean,2),0) / intervals.length;
                    const cv = Math.sqrt(variance) / mean;
                    if (cv < 0.3) { stability = 'ç¨³å®š ğŸ”µ'; style = 'stable'; }
                    else if (cv < 0.6) { stability = 'æ³¢åŠ¨ ğŸŸ¡'; style = 'unstable'; }
                    else { stability = 'ä¸ç¨³å®š ğŸ”´'; style = 'very-unstable'; }
                }

                totalCycleSum += parseFloat(avg);
                cycleCount++;
            }

            // å»ºè®®ä¸‹æ¬¡é‡‡è´­
            let next = '-';
            if (avg !== '-' && list.length) {
                const lastDate = new Date(last);
                lastDate.setDate(lastDate.getDate() + Math.round(parseFloat(avg)));
                next = lastDate.toISOString().split('T')[0];
            }

            cycles.push({
                product: prod,
                category,
                count: list.length,
                first,
                last,
                avg,
                min,
                max,
                stability,
                style,
                next
            });
        });

        // æ›´æ–°æ±‡æ€»
        document.getElementById('totalProducts').innerText = cycles.length;
        document.getElementById('totalEntries').innerText = data.length;
        document.getElementById('avgCycle').innerText = cycleCount ? (totalCycleSum/cycleCount).toFixed(1) + 'å¤©' : '-';

        // æ¸²æŸ“è¡¨æ ¼
        const tbody = document.getElementById('cycleBody');
        if (!cycles.length) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;">ğŸ“­ æš‚æ— æ•°æ® Â· Aucune donnÃ©e</td></tr>';
            return;
        }

        let html = '';
        cycles.sort((a,b) => (a.avg==='-'?999:a.avg) - (b.avg==='-'?999:b.avg));
        cycles.forEach(c => {
            html += `<tr>
                <td><strong>${escape(c.product)}</strong></td>
                <td><span class="cat-badge">${escape(c.category)}</span></td>
                <td>${c.count}</td>
                <td>${c.first}</td>
                <td>${c.last}</td>
                <td><strong>${c.avg}</strong>å¤©</td>
                <td>${c.min}/${c.max}</td>
                <td class="${c.style}">${c.stability}</td>
                <td>${c.next}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // æ›´æ–°äº§å“ä¸‹æ‹‰åˆ—è¡¨
    function updateProductList() {
        const products = [...new Set(records.map(r => r.product))];
        const datalist = document.getElementById('productList');
        datalist.innerHTML = products.map(p => `<option value="${escape(p)}">`).join('');
    }

    // åˆ·æ–°æ‰€æœ‰
    function refreshAll() {
        renderHistory();
        renderStats();
        renderCycle();
        updateProductList();
    }

    // æ·»åŠ è®°å½•
    function addRecord() {
        const inTime = document.getElementById('inTime').value;
        const company = document.getElementById('company').value.trim();
        const product = document.getElementById('product').value.trim();
        const quantity = parseInt(document.getElementById('quantity').value, 10);
        const category = document.getElementById('category').value;

        if (!inTime || !product || !company || isNaN(quantity) || quantity <= 0) {
            alert('è¯·å®Œæ•´å¡«å†™ä¿¡æ¯ Â· Veuillez remplir tous les champs');
            return;
        }

        const newRec = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2,8),
            inTime, company, product, quantity, category
        };
        records.push(newRec);
        saveData();

        // æ¸…ç©ºè¡¨å•
        document.getElementById('company').value = '';
        document.getElementById('product').value = '';
        document.getElementById('quantity').value = '1';

        refreshAll();
    }

    // åˆ é™¤è®°å½•
    function deleteRecord(id) {
        if (confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ Â· Confirmer la suppression ?')) {
            records = records.filter(r => r.id !== id);
            saveData();
            refreshAll();
        }
    }

    // æ‰“å¼€ç¼–è¾‘
    function openEdit(id) {
        const rec = records.find(r => r.id === id);
        if (!rec) return;
        currentEditId = id;
        document.getElementById('editInTime').value = rec.inTime;
        document.getElementById('editCompany').value = rec.company;
        document.getElementById('editProduct').value = rec.product;
        document.getElementById('editQuantity').value = rec.quantity;
        document.getElementById('editCategory').value = rec.category;
        document.getElementById('editModal').classList.add('show');
    }

    // ä¿å­˜ç¼–è¾‘
    function saveEdit() {
        if (!currentEditId) return;
        const idx = records.findIndex(r => r.id === currentEditId);
        if (idx === -1) return;

        const inTime = document.getElementById('editInTime').value;
        const company = document.getElementById('editCompany').value.trim();
        const product = document.getElementById('editProduct').value.trim();
        const quantity = parseInt(document.getElementById('editQuantity').value, 10);
        const category = document.getElementById('editCategory').value;

        if (!inTime || !product || !company || isNaN(quantity) || quantity <= 0) {
            alert('è¯·å®Œæ•´å¡«å†™ä¿¡æ¯ Â· Veuillez remplir tous les champs');
            return;
        }

        records[idx] = { ...records[idx], inTime, company, product, quantity, category };
        saveData();
        document.getElementById('editModal').classList.remove('show');
        currentEditId = null;
        refreshAll();
    }

    // æ¸…é™¤å…¨éƒ¨
    function clearAll() {
        if (confirm('ç¡®è®¤æ¸…é™¤å…¨éƒ¨è®°å½•ï¼Ÿ Â· Effacer tout l\'historique ?')) {
            records = [];
            saveData();
            refreshAll();
        }
    }

    // è®¾ç½®é»˜è®¤æ—¶é—´
    function setDefaultTime() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,'0');
        const d = String(now.getDate()).padStart(2,'0');
        const h = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        document.getElementById('inTime').value = `${y}-${m}-${d}T${h}:${min}`;
    }

    // äº‹ä»¶ç›‘å¬ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç¡®ä¿åŠ¨æ€æŒ‰é’®æœ‰æ•ˆ
    function initEvents() {
        // æ·»åŠ æŒ‰é’®
        document.getElementById('addBtn').addEventListener('click', addRecord);

        // å†å²åˆ†ç±»ç­›é€‰
        document.querySelectorAll('#historyFilter .filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#historyFilter .filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                historyFilter = this.dataset.filter;
                renderHistory();
            });
        });

        // å‘¨æœŸåˆ†ç±»ç­›é€‰
        document.querySelectorAll('#cycleFilter .filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#cycleFilter .filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                cycleFilter = this.dataset.cycle;
                renderCycle();
            });
        });

        // ç»Ÿè®¡ç±»åˆ«æ”¹å˜
        document.getElementById('statsCat').addEventListener('change', renderStats);

        // æ¸…é™¤å…¨éƒ¨
        document.getElementById('clearAllBtn').addEventListener('click', clearAll);

        // å†å²è¡¨æ ¼å†…çš„ç¼–è¾‘/åˆ é™¤ - äº‹ä»¶å§”æ‰˜
        document.getElementById('historyBody').addEventListener('click', function(e) {
            const target = e.target;
            if (target.classList.contains('btn-edit')) {
                const id = target.dataset.id;
                if (id) openEdit(id);
            } else if (target.classList.contains('btn-delete')) {
                const id = target.dataset.id;
                if (id) deleteRecord(id);
            }
        });

        // ç¼–è¾‘å¼¹çª—æŒ‰é’®
        document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
        document.getElementById('cancelEditBtn').addEventListener('click', function() {
            document.getElementById('editModal').classList.remove('show');
            currentEditId = null;
        });
    }

    // å¯åŠ¨
    function init() {
        setDefaultTime();
        refreshAll();
        initEvents();
    }

    init();
})();
</script>
</body>
</html>
